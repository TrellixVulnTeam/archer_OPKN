---
- include_tasks: disable_service.yml
  loop:
    - netctl.service
    - NetworkManager.service
  tags:
    - sudoforge.networkd

- name: Apply the interface configuration template
  template:
    src: network.j2
    dest: "/etc/systemd/network/{{ item.priority }}-{{ item.name }}.network"
    mode: 0644
  notify: restart systemd network services
  loop: "{{ sudoforge_networkd_profiles }}"
  tags:
    - sudoforge.networkd

- name: Create symlink to systemd's resolvconf at /etc/resolv.conf
  file:
    force: "yes"
    path: /etc/resolv.conf
    state: link
    src: /run/systemd/resolve/stub-resolv.conf
  tags:
    - notest
    - sudoforge.networkd

- name: Enable and start systemd's network services
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - systemd-networkd.service
    - systemd-resolved.service
  tags:
    - sudoforge.networkd
